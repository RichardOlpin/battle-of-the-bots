<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraFlow - Debug Authentication</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
        }

        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #357ae8;
        }

        .output {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .error {
            color: #d32f2f;
        }

        .success {
            color: #388e3c;
        }

        .info {
            color: #1976d2;
        }
    </style>
</head>

<body>
    <h1>AuraFlow Calendar - Authentication Debug</h1>

    <div class="section">
        <h2>1. Check Configuration</h2>
        <button onclick="checkConfig()">Check Configuration</button>
        <div id="config-output" class="output"></div>
    </div>

    <div class="section">
        <h2>2. Check Extension ID</h2>
        <button onclick="checkExtensionId()">Get Extension ID</button>
        <div id="extension-output" class="output"></div>
    </div>

    <div class="section">
        <h2>3. Test OAuth URL</h2>
        <button onclick="testOAuthUrl()">Generate OAuth URL</button>
        <div id="oauth-output" class="output"></div>
    </div>

    <div class="section">
        <h2>4. Test Authentication</h2>
        <button onclick="testAuth()">Test Authentication</button>
        <div id="auth-output" class="output"></div>
    </div>

    <div class="section">
        <h2>5. Check Storage</h2>
        <button onclick="checkStorage()">Check Stored Tokens</button>
        <button onclick="clearStorage()">Clear Storage</button>
        <div id="storage-output" class="output"></div>
    </div>

    <div class="section">
        <h2>6. Test Service Worker</h2>
        <button onclick="pingServiceWorker()">Ping Service Worker</button>
        <div id="sw-output" class="output"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const output = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            output.innerHTML += `<span class="${className}">${message}</span>\n`;
        }

        function clear(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function checkConfig() {
            clear('config-output');
            log('config-output', 'Checking configuration...\n');

            try {
                const manifest = chrome.runtime.getManifest();

                log('config-output', `Extension Name: ${manifest.name}`, 'success');
                log('config-output', `Version: ${manifest.version}`, 'success');

                if (manifest.oauth2) {
                    const clientId = manifest.oauth2.client_id;
                    log('config-output', `\nClient ID: ${clientId}`, 'success');

                    if (clientId === 'YOUR_GOOGLE_CLIENT_ID_HERE') {
                        log('config-output', '\n❌ ERROR: Client ID not configured!', 'error');
                        log('config-output', 'Please update manifest.json with your actual Client ID', 'error');
                    } else {
                        log('config-output', '✓ Client ID is configured', 'success');
                    }

                    log('config-output', `\nScopes: ${manifest.oauth2.scopes.join(', ')}`, 'info');
                } else {
                    log('config-output', '\n❌ ERROR: oauth2 section not found in manifest!', 'error');
                }

                log('config-output', `\nPermissions: ${manifest.permissions.join(', ')}`, 'info');
                log('config-output', `Host Permissions: ${manifest.host_permissions.join(', ')}`, 'info');

            } catch (error) {
                log('config-output', `\n❌ ERROR: ${error.message}`, 'error');
            }
        }

        async function checkExtensionId() {
            clear('extension-output');
            log('extension-output', 'Getting extension ID...\n');

            try {
                const extensionId = chrome.runtime.id;
                log('extension-output', `Extension ID: ${extensionId}`, 'success');

                const redirectUrl = chrome.identity.getRedirectURL();
                log('extension-output', `\nRedirect URL: ${redirectUrl}`, 'success');

                log('extension-output', '\n⚠️ IMPORTANT: Make sure this redirect URL is added to your Google Cloud Console:', 'info');
                log('extension-output', '1. Go to Google Cloud Console → Credentials', 'info');
                log('extension-output', '2. Edit your OAuth 2.0 Client ID', 'info');
                log('extension-output', '3. Add this URL to "Authorized redirect URIs":', 'info');
                log('extension-output', redirectUrl, 'info');

            } catch (error) {
                log('extension-output', `\n❌ ERROR: ${error.message}`, 'error');
            }
        }

        async function testOAuthUrl() {
            clear('oauth-output');
            log('oauth-output', 'Generating OAuth URL...\n');

            try {
                const manifest = chrome.runtime.getManifest();
                const clientId = manifest.oauth2.client_id;
                const scopes = manifest.oauth2.scopes;
                const redirectUri = chrome.identity.getRedirectURL();

                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                    `client_id=${clientId}&` +
                    `response_type=token&` +
                    `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                    `scope=${encodeURIComponent(scopes.join(' '))}`;

                log('oauth-output', 'OAuth URL generated:', 'success');
                log('oauth-output', authUrl, 'info');

                log('oauth-output', '\n✓ You can test this URL manually:', 'info');
                log('oauth-output', '1. Copy the URL above', 'info');
                log('oauth-output', '2. Paste it in a new browser tab', 'info');
                log('oauth-output', '3. Complete the OAuth flow', 'info');
                log('oauth-output', '4. Check if it redirects to your extension', 'info');

            } catch (error) {
                log('oauth-output', `\n❌ ERROR: ${error.message}`, 'error');
            }
        }

        async function testAuth() {
            clear('auth-output');
            log('auth-output', 'Testing authentication...\n');

            try {
                log('auth-output', 'Sending authenticate message to service worker...', 'info');

                const response = await chrome.runtime.sendMessage({ action: 'authenticate' });

                if (response.success) {
                    log('auth-output', '\n✓ Authentication successful!', 'success');
                    log('auth-output', JSON.stringify(response.data, null, 2), 'success');
                } else {
                    log('auth-output', '\n❌ Authentication failed:', 'error');
                    log('auth-output', `Error: ${response.error}`, 'error');
                    if (response.details) {
                        log('auth-output', `Details: ${response.details}`, 'error');
                    }
                }

            } catch (error) {
                log('auth-output', `\n❌ ERROR: ${error.message}`, 'error');
                log('auth-output', `Stack: ${error.stack}`, 'error');
            }
        }

        async function checkStorage() {
            clear('storage-output');
            log('storage-output', 'Checking stored tokens...\n');

            try {
                const result = await chrome.storage.local.get(['auraflow_tokens']);

                if (result.auraflow_tokens) {
                    log('storage-output', '✓ Tokens found in storage:', 'success');

                    const tokens = result.auraflow_tokens;
                    log('storage-output', `\nAccess Token: ${tokens.access_token ? tokens.access_token.substring(0, 20) + '...' : 'None'}`, 'info');
                    log('storage-output', `Token Type: ${tokens.token_type || 'None'}`, 'info');

                    if (tokens.expires_at) {
                        const expiresAt = new Date(tokens.expires_at);
                        const now = new Date();
                        const isExpired = now > expiresAt;

                        log('storage-output', `Expires At: ${expiresAt.toLocaleString()}`, 'info');
                        log('storage-output', `Status: ${isExpired ? '❌ EXPIRED' : '✓ Valid'}`, isExpired ? 'error' : 'success');
                    }
                } else {
                    log('storage-output', '⚠️ No tokens found in storage', 'info');
                    log('storage-output', 'You need to authenticate first', 'info');
                }

            } catch (error) {
                log('storage-output', `\n❌ ERROR: ${error.message}`, 'error');
            }
        }

        async function clearStorage() {
            clear('storage-output');
            log('storage-output', 'Clearing storage...\n');

            try {
                await chrome.storage.local.remove(['auraflow_tokens']);
                log('storage-output', '✓ Storage cleared successfully', 'success');
                log('storage-output', 'You can now try authenticating again', 'info');

            } catch (error) {
                log('storage-output', `\n❌ ERROR: ${error.message}`, 'error');
            }
        }

        async function pingServiceWorker() {
            clear('sw-output');
            log('sw-output', 'Pinging service worker...\n');

            try {
                const response = await chrome.runtime.sendMessage({ action: 'ping' });

                if (response.success) {
                    log('sw-output', '✓ Service worker is responsive!', 'success');
                    log('sw-output', JSON.stringify(response.data, null, 2), 'success');
                } else {
                    log('sw-output', '❌ Service worker responded with error:', 'error');
                    log('sw-output', JSON.stringify(response, null, 2), 'error');
                }

            } catch (error) {
                log('sw-output', `\n❌ ERROR: ${error.message}`, 'error');
                log('sw-output', 'Service worker may not be running', 'error');
            }
        }

        // Auto-run config check on load
        window.addEventListener('DOMContentLoaded', () => {
            checkConfig();
            checkExtensionId();
        });
    </script>
</body>

</html>